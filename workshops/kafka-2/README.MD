# Kafka workshop-2

## Основные термины (Шпаргалка)

* Broker - Инстанс кафки (Завод)
* Cluster - Заводской комплекс (Несколько брокеров, объединенных в кластер)
* Topic - Способ организации сообщений определенной категории внутри Kafkа. Это Цех с лентами в заводском комплексе.
* Partition - "Лента внутри цеха" - (Конкретный транзакционный лог)
* Replication Factor - Сколько копий каждой "ленты" (Партиции) надо поддерживать на заводе.
* Partition key - Маркировка на посылке - чтобы уложить ее в нужную ленту
* Алгоритм партиционирования (Partitoneer) - Способ обработки маркировки на "посылках". Определяется продюсером
* Partition Count - Сколько лент в "Цехе" (Партиций в топике)
* Producer - Тот кто кладет посылки на ленту
* Consumer - Тот кто считывает посылки с ленты
* Offset - Указатель у консюмера какую последнюю посылку в ленте он обработал

## Воркшоп - 2

### Предварительные условия

1. Должен быть установлен docker или podman (docker-compose или podman-compose - соответственно)
2. Должны быть свободны локальные порты:
   2181 - для ZooKeeper
   8084 - для Kafka-UI
   9094 - для доступа к kafka-broker
3. (Опционально) Если у вас podman вы можете заменять docker на podman в каждой команде или сделайте алиасы в `~.zshrc`
4. Kafka должна быть запущена

### Воркшоп Kafa-2

#### 1. Создадим Топик test и запишем несколько событий (основы работы консюмеров в группе):

1.1 Откроем терминал:

mac/Linux:

```bash
docker run -it --rm -v $(pwd):/data --network kafka-1_kafka-network gitlab-registry.ozon.ru/route-mentors/kafka-workshops/confluentinc/cp-kafka:7.2.0 /bin/bash
```

Windows:

```bash
docker run -it --rm -v ${pwd}:/data --network kafka-1_kafka-network gitlab-registry.ozon.ru/route-mentors/kafka-workshops/confluentinc/cp-kafka:7.2.0 /bin/bash
```

1.2 Создадим Топик test с 1 партицией (можете через UI а можете через консоль)

Пример команды:

```bash
 kafka-topics --create --topic test --bootstrap-server kafka_1:9092
````

1.3 Запустим 2 консольных консюмера - в 1 группе по топику с 1 партицией в 2 разных терминалах

```bash
kafka-console-consumer --bootstrap-server kafka_1:9092 --topic test --property print.key=true --property key.separator=":" --group g1
```

1.4 Запустим консольный продюсер:

```bash
kafka-console-producer --topic test --bootstrap-server kafka_1:9092 --property parse.key=true --property key.separator=":"
```

1:5 Создадим несколько событий с разными ключами

```
1:1
2:2
3:3
4:4
```

Все события попали в 1 консюмер. Почему так происходит?

Посмотреть статус консюмер-группы в kafka-ui можно тут [Тут](http://localhost:8084/ui/clusters/kafka_1/consumer-groups/g1)

Посмотрим - в конфиги

Увидим как сообщения появились в консоли

1:6 Посмотрим на UI - какой консюмер назначен 0 партиции.

1.7 Остановим и пересоздадим 1 из консольных консюмеров и запишем сообщения в топик

1.8 Теперь другой консюмер будет получать сообщения. (Если этого не произошло - перезапустите консюмер еще раз)






#### 2. Увеличим количество партиций в топике test:

1) Зайдем в UI в настройки топика - и изменим параметр partition count до 2 (мы делали это ранее - у вас все получится!)
2) Запишем несколько сообщений в топик
```bash
kafka-console-producer --topic test --bootstrap-server kafka_1:9092 --property parse.key=true --property key.separator=":"
```
3) Увидим что 1 консюмер все еще получает все сообщения.
4) Переподключим 1 из консюмеров - дождемся процесса ребалансировки
5) Зайдем на UI в свойство консюмер-групп - и посмотрим что ребалансировка произошла
5) Запишем несколько сообщений в топик с разными ключами - увидим что оба наших консольных консюмера получают разные события


### 2.1 Посмотрим как работает ребаланс

1) Включим логи kafka брокера в новом терминале:
```bash
docker container logs -f kafka_1
```
2) Пошлем в 1 из консолей наших консюмеров ctrl+c
3) Увидим в логах - что запустился процесс ребалансировки
4) Посмотрим теперь - какой консюмер куда назначен командой:
```bash
kafka-consumer-groups --bootstrap-server kafka_1:9092 --describe --group g1
```
3) А теперь запустим консюмер, который остановили в пункте 2
4) Увидим в логах - что запустился процесс ребалансировки еще раз 
5) Запустим команду из пункта 4 еще раз
   (если ничего не поменялось - шаги можно повторить - смена назначенных партиций - не гарантируется)

#### 3. Ресет оффсета конкретного консюмера:

1) Откроем консоль в docker
2) Выполним команду - Сместим оффсет консюмера на 3 позиции в рамках каждой партиции топика test

```bash
kafka-consumer-groups --bootstrap-server kafka_1:9092 --execute --reset-offsets --shift-by -3 --group g1 --topic test_2
```

3) Получим сообщение об ошибке - так как управлять смещением можно только по неактивно группе консюмеров
4) Остановим наши консюмеры (ctr+c)
5) Выполним команду из пункта 2 - еще раз
6) Запустим наши консюмеры 

```bash
kafka-console-consumer --bootstrap-server kafka_1:9092 --topic test --property print.key=true --property key.separator=":" --group g1
```

7) Увидим что каждый консюмер вычитал по 3 сообщения из каждой партиции
